---
import BaseLayout from "../layouts/BaseLayout.astro";
import FormCard from "../components/AuthFormCard.astro";
const pageTitle = "Sign Up Carefully";

const inputs = [
    {
        id: "username",
        name: "username",
        type: "text",
        label: "Username",
        placeholder: "Enter username",
    },
    {
        id: "password",
        name: "password",
        type: "password",
        label: "Password",
        placeholder: "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",
        togglePassword: true,
    },
    {
        id: "confirmPassword",
        name: "confirmPassword",
        type: "password",
        label: "Confirm Password",
        placeholder: "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",
        togglePassword: true,
    },
];
---

<BaseLayout pageTitle={pageTitle}>
    <section
        class="min-h-screen flex justify-center items-center text-zinc-950 p-4"
    >
        <FormCard
            title="Enters into taksh's room."
            description="Register wisely. Taksh doesnâ€™t forgetâ€¦ and neither does the system."
            footer="Built by Taksh Â· Observed by Taksh Â· Judged emotionally by Taksh ðŸ˜œ"
            inputs={inputs}
            buttonText="Filed"
            buttonId="registerBtn"
            onButtonClick="handleRegister()"
        />
    </section>
    <div
        id="registerPopup"
        class="fixed bottom-6 left-6 hidden z-50 min-w-70 max-w-sm
           rounded-xl px-5 py-4 shadow-lg text-white text-sm font-medium
           transition-all duration-300"
    >
    </div>
</BaseLayout>

<script is:inline>
    const passwordInput = document.getElementById("password");
    const confirmInput = document.getElementById("confirmPassword");
    const togglePasswordBtn = document.getElementById("togglepassword");
    const toggleConfirmBtn = document.getElementById("toggleconfirmPassword");
    const registerBtn = document.getElementById("registerBtn");
    const usernameInput = document.getElementById("username");
    const originalBtnText = registerBtn.textContent;
    let isLoading = false;
    const popup = document.getElementById("registerPopup");
    let popupTimer = null;

    function showPopup(type, message) {
        if (!popup) return;

        clearTimeout(popupTimer);

        popup.classList.remove(
            "hidden",
            "bg-green-600",
            "bg-red-600",
            "bg-blue-600",
        );

        switch (type) {
            case "success":
                popup.classList.add("bg-green-600");
                break;
            case "error":
                popup.classList.add("bg-red-600");
                break;
            default:
                popup.classList.add("bg-blue-600");
        }

        popup.textContent = message;

        popupTimer = setTimeout(() => {
            popup.classList.add("hidden");
        }, 3000);
    }

    function toggleVisibility(input, btn) {
        const isHidden = input.type === "password";
        input.type = isHidden ? "text" : "password";
        btn.textContent = isHidden ? "ðŸ™ˆ" : "ðŸ‘ï¸";
    }
    if (togglePasswordBtn)
        togglePasswordBtn.addEventListener("click", () =>
            toggleVisibility(passwordInput, togglePasswordBtn),
        );
    if (toggleConfirmBtn)
        toggleConfirmBtn.addEventListener("click", () =>
            toggleVisibility(confirmInput, toggleConfirmBtn),
        );
    function updateRegisterBtn() {
        if (isLoading) return;
        registerBtn.disabled =
            !usernameInput.value.trim() ||
            !passwordInput.value.trim() ||
            passwordInput.value.trim() != confirmInput.value.trim() ||
            !confirmInput.value.trim();
    }
    [usernameInput, passwordInput, confirmInput].forEach((el) =>
        el.addEventListener("input", updateRegisterBtn),
    );

    updateRegisterBtn();
    function setLoading(state) {
        isLoading = state;
        registerBtn.disabled = state;
        registerBtn.textContent = state ? "Filingâ€¦" : originalBtnText;
    }
    async function handleRegister() {
        if (isLoading) return;
        if (
            !usernameInput.value.trim() ||
            !passwordInput.value.trim() ||
            passwordInput.value.trim() != confirmInput.value.trim() ||
            !confirmInput.value.trim()
        ) {
            showPopup("error", "Empty Inputs. register blocked.");
            return;
        }
        setLoading(true);
        const payload = {
            username: usernameInput.value.trim(),
            password: passwordInput.value.trim(),
        };

        try {
            const response = await fetch(
                "http://localhost:5200/auth/register",
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(payload),
                },
            );
            const data = await response.json();
            if (!response.ok) {
                showPopup("error", data.message || "Registration failed.");
                setLoading(false);
                return;
            }
            showPopup("success", "User created successfully.");
            sessionStorage.setItem(
                "registerPopup",
                JSON.stringify({
                    type: "success",
                    message: "User created successfully. Please log in.",
                }),
            );
            setTimeout(() => {
                window.location.href = "/login";
            }, 800);
        } catch (err) {
            showPopup("error", "Network failure. Case unresolved." + err);
            setLoading(false);
        }
    }
    const storedPopup = sessionStorage.getItem("registerPopup");

    if (storedPopup) {
        sessionStorage.removeItem("registerPopup");
    }
</script>
