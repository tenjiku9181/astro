---
import FormCard from "../components/AuthFormCard.astro";
import BaseLayout from "../layouts/BaseLayout.astro";
const loginInputs = [
    {
        id: "username",
        name: "username",
        type: "text",
        label: "Username",
        placeholder: "Username",
    },
    {
        id: "password",
        name: "password",
        type: "password",
        label: "Password",
        placeholder: "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",
        togglePassword: true,
    },
];
const pageTitle = "Welcome Back";
---

<BaseLayout pageTitle={pageTitle}>
    <section
        class="min-h-screen flex justify-center items-center text-zinc-950 p-4"
    >
        <FormCard
            title="Taksh Was Expecting You."
            description="For taksh and his personnel only authorized"
            footer="If youâ€™re not supposed to be here, Taksh already knows. ðŸ¤”"
            inputs={loginInputs}
            buttonText="Seen"
            buttonId="loginBtn"
            onButtonClick="handleLogin()"
        />
    </section>
    <div
        id="loginPopup"
        class="fixed bottom-6 left-6 hidden z-50 min-w-70 max-w-sm
           rounded-xl px-5 py-4 shadow-lg text-white text-sm font-medium
           transition-all duration-300"
    >
    </div>
</BaseLayout>
<script is:inline>
    const passwordInput = document.getElementById("password");
    const usernameInput = document.getElementById("username");
    const toggleBtn = document.getElementById("togglepassword");
    const loginBtn = document.getElementById("loginBtn");
    const originalBtnText = loginBtn.textContent;
    let isLoading = false;
    const popup = document.getElementById("loginPopup");
    let popupTimer = null;

    function showPopup(type, message) {
        if (!popup) return;

        clearTimeout(popupTimer);

        popup.classList.remove(
            "hidden",
            "bg-green-600",
            "bg-red-600",
            "bg-blue-600",
        );

        switch (type) {
            case "success":
                popup.classList.add("bg-green-600");
                break;
            case "error":
                popup.classList.add("bg-red-600");
                break;
            default:
                popup.classList.add("bg-blue-600");
        }

        popup.textContent = message;

        popupTimer = setTimeout(() => {
            popup.classList.add("hidden");
        }, 3000);
    }

    toggleBtn.addEventListener("click", () => {
        const isHidden = passwordInput.type === "password";
        passwordInput.type = isHidden ? "text" : "password";
        toggleBtn.textContent = isHidden ? "ðŸ™ˆ" : "ðŸ‘ï¸";
    });
    function updateLoginBtn() {
        if (isLoading) return;
        loginBtn.disabled =
            passwordInput.value.trim().length === 0 ||
            usernameInput.value.trim().length === 0;
    }
    passwordInput.addEventListener("input", updateLoginBtn);
    usernameInput.addEventListener("input", updateLoginBtn);
    updateLoginBtn();
    function setLoading(state) {
        isLoading = state;
        loginBtn.disabled = state;
        loginBtn.textContent = state ? "Checkingâ€¦" : originalBtnText;
    }
    async function handleLogin() {
        if (isLoading) return;
        if (
            passwordInput.value.trim().length === 0 ||
            usernameInput.value.trim().length === 0
        ) {
            showPopup("error", "Empty Inputs. login blocked.");
            return;
        }
        setLoading(true);
        const payload = {
            username: usernameInput.value.trim(),
            password: passwordInput.value.trim(),
        };

        try {
            const response = await fetch("http://localhost:5200/auth/login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            });
            const data = await response.json();
            if (!response.ok) {
                showPopup("error", data.message || "Log in failed.");
                setLoading(false);
                return;
            }
            showPopup("success", "User login successfully.");
            localStorage.setItem("taksh's token", data.token);
            sessionStorage.setItem(
                "loginPopup",
                JSON.stringify({
                    type: "success",
                    message: "User login successfully.",
                }),
            );
            setTimeout(() => {
                window.location.href = "/form";
            }, 800);
        } catch (err) {
            showPopup("error", "Network failure. Case unresolved." + err);
            setLoading(false);
        }
    }
    const storedPopup = sessionStorage.getItem("loginPopup");

    if (storedPopup) {
        sessionStorage.removeItem("loginPopup");
    }
</script>
